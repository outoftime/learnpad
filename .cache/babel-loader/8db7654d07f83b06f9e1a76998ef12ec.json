{
  "ast": null,
  "code": "function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nimport castArray from 'lodash-es/castArray';\nimport compact from 'lodash-es/compact';\nimport flatMap from 'lodash-es/flatMap';\nimport isEmpty from 'lodash-es/isEmpty';\nimport map from 'lodash-es/map';\nimport trim from 'lodash-es/trim';\nimport uniq from 'lodash-es/uniq';\nimport config from '../config';\nimport retryingFailedImports from './retryingFailedImports';\nvar downloadingScript = downloadScript();\nvar parser = new DOMParser();\nexport var sourceDelimiter = '/*__POPCODESTART__*/';\n\nfunction downloadScript() {\n  return _downloadScript.apply(this, arguments);\n}\n\nfunction _downloadScript() {\n  _downloadScript = _asyncToGenerator(\n  /*#__PURE__*/\n  regeneratorRuntime.mark(function _callee() {\n    var responses, scripts;\n    return regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (!(config.nodeEnv === 'test')) {\n              _context.next = 2;\n              break;\n            }\n\n            return _context.abrupt(\"return\", '');\n\n          case 2:\n            _context.next = 4;\n            return Promise.all(map(document.querySelectorAll('.preview-bundle'), function (el) {\n              return fetch(el.src);\n            }));\n\n          case 4:\n            responses = _context.sent;\n            _context.next = 7;\n            return Promise.all(responses.map(function (response) {\n              return response.text();\n            }));\n\n          case 7:\n            scripts = _context.sent;\n            return _context.abrupt(\"return\", scripts.join('\\n'));\n\n          case 9:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n  return _downloadScript.apply(this, arguments);\n}\n\nfunction constructDocument(project) {\n  var doc = parser.parseFromString(project.sources.html, 'text/html');\n  ensureDocumentElement(doc);\n  ensureElement(doc, 'head');\n  ensureElement(doc, 'body');\n  return doc;\n}\n\nfunction ensureElement(doc, elementName) {\n  var element = doc[elementName];\n\n  if (!element) {\n    element = doc.createElement(elementName);\n    doc.documentElement.appendChild(element);\n  }\n}\n\nfunction ensureDocumentElement(doc) {\n  var documentElement = doc.documentElement;\n\n  if (!documentElement) {\n    documentElement = doc.createElement('html');\n    doc.appendChild(documentElement);\n  }\n}\n\nfunction attachLibraries(_x, _x2) {\n  return _attachLibraries.apply(this, arguments);\n}\n\nfunction _attachLibraries() {\n  _attachLibraries = _asyncToGenerator(\n  /*#__PURE__*/\n  regeneratorRuntime.mark(function _callee2(doc, project) {\n    var enabledLibrariesWithDependencies, libraries, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, libraryKey, library;\n\n    return regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            _context2.next = 2;\n            return librariesWithDependencies(project.enabledLibraries);\n\n          case 2:\n            enabledLibrariesWithDependencies = _context2.sent;\n\n            if (!isEmpty(enabledLibrariesWithDependencies)) {\n              _context2.next = 5;\n              break;\n            }\n\n            return _context2.abrupt(\"return\");\n\n          case 5:\n            _context2.next = 7;\n            return importLibraries();\n\n          case 7:\n            libraries = _context2.sent;\n            _iteratorNormalCompletion3 = true;\n            _didIteratorError3 = false;\n            _iteratorError3 = undefined;\n            _context2.prev = 11;\n            _iterator3 = enabledLibrariesWithDependencies.reverse()[Symbol.iterator]();\n\n          case 13:\n            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {\n              _context2.next = 22;\n              break;\n            }\n\n            libraryKey = _step3.value;\n\n            if (libraryKey in libraries) {\n              _context2.next = 17;\n              break;\n            }\n\n            return _context2.abrupt(\"return\");\n\n          case 17:\n            library = libraries[libraryKey];\n            attachLibrary(doc, library);\n\n          case 19:\n            _iteratorNormalCompletion3 = true;\n            _context2.next = 13;\n            break;\n\n          case 22:\n            _context2.next = 28;\n            break;\n\n          case 24:\n            _context2.prev = 24;\n            _context2.t0 = _context2[\"catch\"](11);\n            _didIteratorError3 = true;\n            _iteratorError3 = _context2.t0;\n\n          case 28:\n            _context2.prev = 28;\n            _context2.prev = 29;\n\n            if (!_iteratorNormalCompletion3 && _iterator3.return != null) {\n              _iterator3.return();\n            }\n\n          case 31:\n            _context2.prev = 31;\n\n            if (!_didIteratorError3) {\n              _context2.next = 34;\n              break;\n            }\n\n            throw _iteratorError3;\n\n          case 34:\n            return _context2.finish(31);\n\n          case 35:\n            return _context2.finish(28);\n\n          case 36:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[11, 24, 28, 36], [29,, 31, 35]]);\n  }));\n  return _attachLibraries.apply(this, arguments);\n}\n\nfunction attachLibrary(doc, library) {\n  var css = library.css,\n      javascript = library.javascript;\n\n  if (css !== undefined) {\n    var _iteratorNormalCompletion = true;\n    var _didIteratorError = false;\n    var _iteratorError = undefined;\n\n    try {\n      for (var _iterator = castArray(css)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n        var styles = _step.value;\n        attachCssLibrary(doc, styles);\n      }\n    } catch (err) {\n      _didIteratorError = true;\n      _iteratorError = err;\n    } finally {\n      try {\n        if (!_iteratorNormalCompletion && _iterator.return != null) {\n          _iterator.return();\n        }\n      } finally {\n        if (_didIteratorError) {\n          throw _iteratorError;\n        }\n      }\n    }\n  }\n\n  if (javascript !== undefined) {\n    var _iteratorNormalCompletion2 = true;\n    var _didIteratorError2 = false;\n    var _iteratorError2 = undefined;\n\n    try {\n      for (var _iterator2 = castArray(javascript)[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {\n        var script = _step2.value;\n        attachJavascriptLibrary(doc, script);\n      }\n    } catch (err) {\n      _didIteratorError2 = true;\n      _iteratorError2 = err;\n    } finally {\n      try {\n        if (!_iteratorNormalCompletion2 && _iterator2.return != null) {\n          _iterator2.return();\n        }\n      } finally {\n        if (_didIteratorError2) {\n          throw _iteratorError2;\n        }\n      }\n    }\n  }\n}\n\nfunction attachCssLibrary(doc, css) {\n  var styleTag = doc.createElement('style');\n  styleTag.textContent = String(css);\n  doc.head.appendChild(styleTag);\n}\n\nfunction attachJavascriptLibrary(doc, javascript) {\n  var scriptTag = doc.createElement('script');\n  var javascriptText = String(javascript);\n  scriptTag.innerHTML = javascriptText.replace(/<\\/script>/g, '<\\\\/script>');\n  var firstScriptTag = doc.scripts[0];\n\n  if (firstScriptTag) {\n    firstScriptTag.parentNode.insertBefore(scriptTag, firstScriptTag);\n  } else {\n    doc.head.appendChild(scriptTag);\n  }\n}\n\nfunction librariesWithDependencies(_x3) {\n  return _librariesWithDependencies.apply(this, arguments);\n}\n\nfunction _librariesWithDependencies() {\n  _librariesWithDependencies = _asyncToGenerator(\n  /*#__PURE__*/\n  regeneratorRuntime.mark(function _callee3(libraryKeys) {\n    var libraries, requestedLibraries, dependencies;\n    return regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            if (!isEmpty(libraryKeys)) {\n              _context3.next = 2;\n              break;\n            }\n\n            return _context3.abrupt(\"return\", libraryKeys);\n\n          case 2:\n            _context3.next = 4;\n            return importLibraries();\n\n          case 4:\n            libraries = _context3.sent;\n            requestedLibraries = libraryKeys.map(function (libraryKey) {\n              return libraries[libraryKey];\n            });\n            dependencies = compact(flatMap(requestedLibraries, 'dependsOn'));\n            return _context3.abrupt(\"return\", uniq(compact(librariesWithDependencies(dependencies)).concat(libraryKeys)));\n\n          case 8:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee3);\n  }));\n  return _librariesWithDependencies.apply(this, arguments);\n}\n\nfunction importLibraries() {\n  return _importLibraries.apply(this, arguments);\n}\n\nfunction _importLibraries() {\n  _importLibraries = _asyncToGenerator(\n  /*#__PURE__*/\n  regeneratorRuntime.mark(function _callee4() {\n    return regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            return _context4.abrupt(\"return\", retryingFailedImports(function () {\n              return import(\n              /* webpackChunkName: \"previewLibraries\" */\n              '../config/libraryAssets');\n            }));\n\n          case 1:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n  return _importLibraries.apply(this, arguments);\n}\n\nfunction addBase(doc) {\n  var head = doc.head;\n  var baseTag = doc.createElement('base');\n  baseTag.target = '_top';\n  var firstChild = head.childNodes[0];\n\n  if (firstChild) {\n    head.insertBefore(baseTag, firstChild);\n  } else {\n    head.appendChild(baseTag);\n  }\n}\n\nfunction addCss(doc, _ref) {\n  var css = _ref.sources.css;\n  var styleTag = doc.createElement('style');\n  styleTag.innerHTML = css;\n  doc.head.appendChild(styleTag);\n}\n\nfunction addPreviewSupportScript(_x4) {\n  return _addPreviewSupportScript.apply(this, arguments);\n}\n\nfunction _addPreviewSupportScript() {\n  _addPreviewSupportScript = _asyncToGenerator(\n  /*#__PURE__*/\n  regeneratorRuntime.mark(function _callee5(doc) {\n    var downloadedScript, scriptTag;\n    return regeneratorRuntime.wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            _context5.next = 2;\n            return downloadingScript;\n\n          case 2:\n            downloadedScript = _context5.sent;\n            scriptTag = doc.createElement('script');\n            scriptTag.innerHTML = downloadedScript;\n            doc.head.appendChild(scriptTag);\n\n          case 6:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5);\n  }));\n  return _addPreviewSupportScript.apply(this, arguments);\n}\n\nfunction addJavascript(_x5, _x6, _x7) {\n  return _addJavascript.apply(this, arguments);\n}\n\nfunction _addJavascript() {\n  _addJavascript = _asyncToGenerator(\n  /*#__PURE__*/\n  regeneratorRuntime.mark(function _callee6(doc, _ref2, _ref3) {\n    var javascript, _ref3$breakLoops, breakLoops, source, _ref5, loopBreaker, scriptTag;\n\n    return regeneratorRuntime.wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            javascript = _ref2.sources.javascript;\n            _ref3$breakLoops = _ref3.breakLoops, breakLoops = _ref3$breakLoops === void 0 ? false : _ref3$breakLoops;\n\n            if (!(trim(javascript).length === 0)) {\n              _context6.next = 4;\n              break;\n            }\n\n            return _context6.abrupt(\"return\");\n\n          case 4:\n            source = \"\\n\".concat(sourceDelimiter, \"\\n\").concat(javascript);\n\n            if (!breakLoops) {\n              _context6.next = 11;\n              break;\n            }\n\n            _context6.next = 8;\n            return retryingFailedImports(function () {\n              return import(\n              /* webpackChunkName: \"mainAsync\" */\n              'loop-breaker');\n            });\n\n          case 8:\n            _ref5 = _context6.sent;\n            loopBreaker = _ref5.default;\n            source = loopBreaker(source);\n\n          case 11:\n            scriptTag = doc.createElement('script');\n            scriptTag.innerHTML = source;\n            doc.body.appendChild(scriptTag);\n\n          case 14:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  }));\n  return _addJavascript.apply(this, arguments);\n}\n\nexport function generateTextPreview(project) {\n  var _constructDocument = constructDocument(project),\n      title = _constructDocument.title;\n\n  return (title || '').trim();\n}\nexport default function compileProject(_x8) {\n  return _compileProject.apply(this, arguments);\n}\n\nfunction _compileProject() {\n  _compileProject = _asyncToGenerator(\n  /*#__PURE__*/\n  regeneratorRuntime.mark(function _callee7(project) {\n    var _ref4,\n        isInlinePreview,\n        doc,\n        _args7 = arguments;\n\n    return regeneratorRuntime.wrap(function _callee7$(_context7) {\n      while (1) {\n        switch (_context7.prev = _context7.next) {\n          case 0:\n            _ref4 = _args7.length > 1 && _args7[1] !== undefined ? _args7[1] : {}, isInlinePreview = _ref4.isInlinePreview;\n            doc = constructDocument(project);\n            _context7.next = 4;\n            return attachLibraries(doc, project);\n\n          case 4:\n            if (isInlinePreview) {\n              addBase(doc);\n            }\n\n            addCss(doc, project);\n\n            if (!isInlinePreview) {\n              _context7.next = 9;\n              break;\n            }\n\n            _context7.next = 9;\n            return addPreviewSupportScript(doc);\n\n          case 9:\n            _context7.next = 11;\n            return addJavascript(doc, project, {\n              breakLoops: isInlinePreview\n            });\n\n          case 11:\n            return _context7.abrupt(\"return\", {\n              title: (doc.title || '').trim(),\n              source: \"<!DOCTYPE html> \".concat(doc.documentElement.outerHTML)\n            });\n\n          case 12:\n          case \"end\":\n            return _context7.stop();\n        }\n      }\n    }, _callee7);\n  }));\n  return _compileProject.apply(this, arguments);\n}",
  "map": {
    "version": 3,
    "sources": ["/Users/peter/Desktop/code/popcode/src/util/compileProject.js"],
    "names": [
      "castArray",
      "compact",
      "flatMap",
      "isEmpty",
      "map",
      "trim",
      "uniq",
      "config",
      "retryingFailedImports",
      "downloadingScript",
      "downloadScript",
      "parser",
      "DOMParser",
      "sourceDelimiter",
      "nodeEnv",
      "Promise",
      "all",
      "document",
      "querySelectorAll",
      "el",
      "fetch",
      "src",
      "responses",
      "response",
      "text",
      "scripts",
      "join",
      "constructDocument",
      "project",
      "doc",
      "parseFromString",
      "sources",
      "html",
      "ensureDocumentElement",
      "ensureElement",
      "elementName",
      "element",
      "createElement",
      "documentElement",
      "appendChild",
      "attachLibraries",
      "librariesWithDependencies",
      "enabledLibraries",
      "enabledLibrariesWithDependencies",
      "importLibraries",
      "libraries",
      "reverse",
      "libraryKey",
      "library",
      "attachLibrary",
      "css",
      "javascript",
      "undefined",
      "styles",
      "attachCssLibrary",
      "script",
      "attachJavascriptLibrary",
      "styleTag",
      "textContent",
      "String",
      "head",
      "scriptTag",
      "javascriptText",
      "innerHTML",
      "replace",
      "firstScriptTag",
      "parentNode",
      "insertBefore",
      "libraryKeys",
      "requestedLibraries",
      "dependencies",
      "concat",
      "addBase",
      "baseTag",
      "target",
      "firstChild",
      "childNodes",
      "addCss",
      "addPreviewSupportScript",
      "downloadedScript",
      "addJavascript",
      "breakLoops",
      "length",
      "source",
      "loopBreaker",
      "default",
      "body",
      "generateTextPreview",
      "title",
      "compileProject",
      "isInlinePreview",
      "outerHTML"
    ],
    "mappings": "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",
    "sourcesContent": [
      "import castArray from 'lodash-es/castArray';\nimport compact from 'lodash-es/compact';\nimport flatMap from 'lodash-es/flatMap';\nimport isEmpty from 'lodash-es/isEmpty';\nimport map from 'lodash-es/map';\nimport trim from 'lodash-es/trim';\nimport uniq from 'lodash-es/uniq';\n\nimport config from '../config';\n\nimport retryingFailedImports from './retryingFailedImports';\n\nconst downloadingScript = downloadScript();\n\nconst parser = new DOMParser();\n\nexport const sourceDelimiter = '/*__POPCODESTART__*/';\n\nasync function downloadScript() {\n  if (config.nodeEnv === 'test') {\n    return '';\n  }\n\n  const responses = await Promise.all(\n    map(document.querySelectorAll('.preview-bundle'), el => fetch(el.src)),\n  );\n  const scripts = await Promise.all(responses.map(response => response.text()));\n  return scripts.join('\\n');\n}\n\nfunction constructDocument(project) {\n  const doc = parser.parseFromString(project.sources.html, 'text/html');\n  ensureDocumentElement(doc);\n  ensureElement(doc, 'head');\n  ensureElement(doc, 'body');\n  return doc;\n}\n\nfunction ensureElement(doc, elementName) {\n  let element = doc[elementName];\n  if (!element) {\n    element = doc.createElement(elementName);\n    doc.documentElement.appendChild(element);\n  }\n}\n\nfunction ensureDocumentElement(doc) {\n  let {documentElement} = doc;\n  if (!documentElement) {\n    documentElement = doc.createElement('html');\n    doc.appendChild(documentElement);\n  }\n}\n\nasync function attachLibraries(doc, project) {\n  const enabledLibrariesWithDependencies = await librariesWithDependencies(\n    project.enabledLibraries,\n  );\n\n  if (isEmpty(enabledLibrariesWithDependencies)) {\n    return;\n  }\n\n  const libraries = await importLibraries();\n\n  for (const libraryKey of enabledLibrariesWithDependencies.reverse()) {\n    if (!(libraryKey in libraries)) {\n      return;\n    }\n\n    const library = libraries[libraryKey];\n    attachLibrary(doc, library);\n  }\n}\n\nfunction attachLibrary(doc, library) {\n  const {css, javascript} = library;\n  if (css !== undefined) {\n    for (const styles of castArray(css)) {\n      attachCssLibrary(doc, styles);\n    }\n  }\n  if (javascript !== undefined) {\n    for (const script of castArray(javascript)) {\n      attachJavascriptLibrary(doc, script);\n    }\n  }\n}\n\nfunction attachCssLibrary(doc, css) {\n  const styleTag = doc.createElement('style');\n  styleTag.textContent = String(css);\n  doc.head.appendChild(styleTag);\n}\n\nfunction attachJavascriptLibrary(doc, javascript) {\n  const scriptTag = doc.createElement('script');\n  const javascriptText = String(javascript);\n  scriptTag.innerHTML = javascriptText.replace(/<\\/script>/gu, '<\\\\/script>');\n  const firstScriptTag = doc.scripts[0];\n  if (firstScriptTag) {\n    firstScriptTag.parentNode.insertBefore(scriptTag, firstScriptTag);\n  } else {\n    doc.head.appendChild(scriptTag);\n  }\n}\n\nasync function librariesWithDependencies(libraryKeys) {\n  if (isEmpty(libraryKeys)) {\n    return libraryKeys;\n  }\n\n  const libraries = await importLibraries();\n\n  const requestedLibraries = libraryKeys.map(\n    libraryKey => libraries[libraryKey],\n  );\n\n  const dependencies = compact(flatMap(requestedLibraries, 'dependsOn'));\n\n  return uniq(\n    compact(librariesWithDependencies(dependencies)).concat(libraryKeys),\n  );\n}\n\nasync function importLibraries() {\n  return retryingFailedImports(() =>\n    import(\n      /* webpackChunkName: \"previewLibraries\" */\n      '../config/libraryAssets'\n    ),\n  );\n}\n\nfunction addBase(doc) {\n  const {head} = doc;\n  const baseTag = doc.createElement('base');\n  baseTag.target = '_top';\n  const firstChild = head.childNodes[0];\n  if (firstChild) {\n    head.insertBefore(baseTag, firstChild);\n  } else {\n    head.appendChild(baseTag);\n  }\n}\n\nfunction addCss(doc, {sources: {css}}) {\n  const styleTag = doc.createElement('style');\n  styleTag.innerHTML = css;\n  doc.head.appendChild(styleTag);\n}\n\nasync function addPreviewSupportScript(doc) {\n  const downloadedScript = await downloadingScript;\n  const scriptTag = doc.createElement('script');\n  scriptTag.innerHTML = downloadedScript;\n  doc.head.appendChild(scriptTag);\n}\n\nasync function addJavascript(\n  doc,\n  {sources: {javascript}},\n  {breakLoops = false},\n) {\n  if (trim(javascript).length === 0) {\n    return;\n  }\n\n  let source = `\\n${sourceDelimiter}\\n${javascript}`;\n  if (breakLoops) {\n    const {default: loopBreaker} = await retryingFailedImports(() =>\n      import(\n        /* webpackChunkName: \"mainAsync\" */\n        'loop-breaker'\n      ),\n    );\n    source = loopBreaker(source);\n  }\n  const scriptTag = doc.createElement('script');\n  scriptTag.innerHTML = source;\n  doc.body.appendChild(scriptTag);\n}\n\nexport function generateTextPreview(project) {\n  const {title} = constructDocument(project);\n  return (title || '').trim();\n}\n\nexport default async function compileProject(project, {isInlinePreview} = {}) {\n  const doc = constructDocument(project);\n\n  await attachLibraries(doc, project);\n  if (isInlinePreview) {\n    addBase(doc);\n  }\n\n  addCss(doc, project);\n  if (isInlinePreview) {\n    await addPreviewSupportScript(doc);\n  }\n  await addJavascript(doc, project, {breakLoops: isInlinePreview});\n\n  return {\n    title: (doc.title || '').trim(),\n    source: `<!DOCTYPE html> ${doc.documentElement.outerHTML}`,\n  };\n}\n"
    ]
  },
  "metadata": {},
  "sourceType": "module"
}
